# 出库扫描采集页面分析

## 1. 功能概述

出库扫描采集页面（goodDownNvue.nvue）是平库出库功能的核心操作界面，主要用于通过扫码方式采集出库物料信息。该页面集成了任务列表查看、扫码采集、库存验证、数据提交等完整的出库作业流程，是仓库操作人员进行实际出库作业的主要工作界面。



## 2. 页面信息

### 2.1 页面文件
- **文件路径**: `/pages/goodsdown/task_collect/goodDownNvue.nvue`
- **页面标题**: "平库下架采集"
- **功能定位**: 出库物料扫码采集和数据处理

### 2.2 页面结构
```
导航栏 (标题 + 左侧返回)
    ↓
扫码输入框 (库位/物料扫描)
    ↓
采集信息卡片区 (库位、库存、物料、数量等)
    ↓
Tab切换区 (任务列表 / 正在采集)
    ↓
数据表格区 (任务明细 / 采集记录)
    ↓
底部操作栏 (采集结果、提交、更多)
    ↓
气泡菜单 (异常采集、报缺)
    ↓
扫码组件
```

## 3. 核心功能分析

### 3.1 页面初始化

**参数接收**:
```javascript
// 从URL参数解析任务信息
let outTask = JSON.parse(decodeURIComponent(options.item));

// 设置任务相关参数
this.outTaskItem.outtaskno = outTask.outtaskno;      // 任务号
this.outTaskItem.taskcomment = outTask.taskcomment;  // 任务备注
this.outTaskItem.forcesite = outTask.forcesite;      // 强制库位
this.outTaskItem.forcebatch = outTask.forcebatch;    // 强制批次
this.outTaskItem.workstation = outTask.workstation;  // 工作站
```

**全局变量初始化**:
```javascript
// 采集控制变量
collectFlg = '';           // 采集标志
matFoundFlg = '';          // 物料找到标志
booCheck = true;           // 是否校验批次
erpStoreSite = '';         // ERP库位
batchFountFlg = '0';       // 批次找到标志

// 采集结果记录
matCode = '';              // 物料编码
batchNo = '';              // 批次号
sn = '';                   // 序列号
pdate = '';                // 生产日期
vdays = '';                // 保质期
matControlFlag = '';       // 物料控制标志
```

### 3.2 数据查询功能

**任务列表查询接口**:
- **接口名称**: `getOutTaskCollitemList`
- **接口地址**: `/system/terminal/getOutTaskItem`
- **功能**: 获取出库任务采集明细列表

**查询参数**:
```javascript
outTaskItem: {
    outtaskno: '',           // 任务号
    storeroomno: '',         // 库房编号
    forcesite: '',           // 强制库位
    forcebatch: '',          // 强制批次
    taskcomment: '',         // 任务备注
    taskFinishFlag: '0',     // 任务完成标志
    roomtag: '0',            // 库房标签
    workstation: 'N',        // 工作站
    finshFlg: '0',           // 完成标志
    sortType: '',            // 排序类型
    sortColumn: '',          // 排序字段
    searchKey: '',           // 搜索关键字
    beatflag: 'N',           // 节拍标志
    collecter: ''            // 采集人员
}
```

### 3.3 扫码采集功能

**扫码处理流程**:
```javascript
// 主要扫码处理方法
PerformingBarcode_pre(content) {
    // 1. 内容验证
    if (!content || content.length === 0) {
        this.showError('采集内容为空,请重新采集');
        return;
    }
    
    // 2. 根据当前步骤处理扫码内容
    switch(this.currentStep) {
        case this.Step.Site:        // 库位扫描
            this.processSiteBarcode(content);
            break;
        case this.Step._2DBarcode:  // 物料二维码扫描
            this.processMaterialBarcode(content);
            break;
        case this.Step.Quantity:    // 数量确认
            this.processQuantityInput(content);
            break;
    }
}
```

**扫码步骤定义**:
```javascript
Step: {
    _2DBarcode: '_2DBarcode',   // 二维码扫描步骤
    Site: 'Site',               // 库位扫描步骤
    Quantity: 'Quantity'        // 数量确认步骤
}
```

**物料控制模式**:
```javascript
MtlCheckMode: {
    Mtl: 'Mtl',                     // 检查物料
    MtlBatch: 'MtlBatch',           // 物料+批号
    MtlSite: 'MtlSite',             // 物料+库位
    MtlBatchSite: 'MtlBatchSite'    // 物料+批号+库位
}
```

### 3.4 库存验证功能

**库存查询接口**:
1. **按库位查询**: `getMtlRepertoryByStoresiteNo`
2. **按库位和序列号查询**: `getMtlRepertoryByStoresiteNosn`
3. **ERP库存查询**: `getMtlRepertoryByStoresiteNoErp`

**库存验证流程**:
```javascript
// 库存检查方法
checkInventory(storesite, matcode, batchno, sn) {
    // 1. 根据序列号选择查询接口
    if (sn && sn.length > 0) {
        return getMtlRepertoryByStoresiteNosn({
            storesite: storesite,
            matcode: matcode,
            batchno: batchno,
            sn: sn
        });
    } else {
        return getMtlRepertoryByStoresiteNo({
            storesite: storesite,
            matcode: matcode,
            batchno: batchno
        });
    }
}
```

### 3.5 数据表格功能

**任务列表表格配置**:
```javascript
column1: [
    { prop: 'matcode', label: '物料编码', width: 180 },
    { prop: 'storesiteno', label: '库位', width: 200 },
    { prop: 'hintqty', label: '任务数量', width: 130 },
    { prop: 'collectedqty', label: '采集数量', width: 130 },
    { prop: 'repqty', label: '结余库存', width: 130, color: '#465CFF' },
    { prop: 'hintbatchno', label: '批次', width: 300 },
    { prop: 'sn', label: '序列', width: 300 },
    { prop: 'storeroomno', label: '库房' },
    { prop: 'subinventoryCode', label: '子库' },
    { prop: 'orderno', label: '出库单号', width: 200 },
    { prop: 'matname', label: '物料名称', width: 200 },
    { prop: 'matinnercode', label: '物料旧编码', width: 250 },
    { prop: 'outtaskitemid', label: '任务id' },
    { prop: 'data1', label: '任务序号' },
    { label: '序号', fixed: 'right', type: 4, width: 100 }
]
```

**采集记录表格配置**:
```javascript
column2: [
    // 与任务列表基本相同，但去掉了序号列
    // 用于显示正在采集的记录
]
```

### 3.6 Tab切换功能

**Tab配置**:
```javascript
tabs: [
    { name: '任务列表', value: 'taskall' },
    { name: '正在采集', value: 'extreing' }
]
```

**切换处理**:
```javascript
onChangeTab(index) {
    this.curTab = index;
    // 根据tab切换显示不同的表格
    // curTab = 0: 显示任务列表
    // curTab = 1: 显示采集记录
}
```

### 3.7 采集结果管理

**采集数据结构**:
```javascript
BarcodeContent: {
    matcode: '',        // 物料编码
    qty: '',            // 采集数量
    matname: '',        // 物料名称
    batchno: '',        // 批次
    sn: '',             // 序列
    pdate: '',          // 生产日期
    vdays: '',          // 保质期
    seqctrl: '',        // 控制方式
    id_old: ''          // 编码方式
}
```

**采集记录存储**:
```javascript
// 采集列表
collectList: [],        // 采集记录列表
stocks: [],             // 库存记录

// 数量控制字典
dicMtlQty: new Map(),   // key: outtaskitemid, value: [开始数量, 本次数量]
dicSeq: new Map(),      // 序列控制字典
dicInvMtlQty: new Map() // 库存数量字典
```

### 3.8 数据提交功能

**提交接口**:
- **接口名称**: `commitDownShelves`
- **功能**: 提交出库采集数据
- **参数**: 采集记录数组

**提交流程**:
```javascript
submitCollectData() {
    // 1. 验证采集数据
    if (this.stocks.length === 0) {
        this.showError('没有可提交的采集记录');
        return;
    }
    
    // 2. 确认提交
    uni.showModal({
        title: '提交确认',
        content: '是否提交采集数据?',
        success: (res) => {
            if (res.confirm) {
                // 3. 调用提交接口
                commitDownShelves(this.stocks).then((response) => {
                    if (response.code === '200') {
                        this.showSuccess('提交成功');
                        this.clearCollectData();
                        this.getList();
                    }
                });
            }
        }
    });
}
```

### 3.9 异常处理功能

**异常采集**:
- 支持异常情况下的强制采集
- 记录异常原因和处理方式

**报缺功能**:
- **接口名称**: `commitFinishOutTaskItem`
- **功能**: 报告物料缺货
- **参数**: 任务明细ID

**报缺流程**:
```javascript
reportShortage(outtaskitemid) {
    uni.showModal({
        title: '报缺确认',
        content: '确认报缺该物料?',
        success: (res) => {
            if (res.confirm) {
                commitFinishOutTaskItem(outtaskitemid).then((response) => {
                    if (response.code === '200') {
                        this.showSuccess('报缺成功');
                        this.getList();
                    }
                });
            }
        }
    });
}
```

## 4. 用户交互流程

### 4.1 标准采集流程
```
进入采集页面
    ↓
扫描库位条码
    ↓
验证库位有效性
    ↓
扫描物料二维码
    ↓
解析物料信息
    ↓
验证库存数量
    ↓
确认采集数量
    ↓
添加到采集记录
    ↓
继续采集或提交数据
```

### 4.2 异常处理流程
```
采集过程中发现异常
    ↓
点击"更多"按钮
    ↓
选择"异常采集"或"报缺"
    ↓
填写异常原因
    ↓
确认异常处理
    ↓
记录异常信息
```

### 4.3 数据提交流程
```
完成物料采集
    ↓
切换到"正在采集"Tab
    ↓
检查采集记录
    ↓
点击"提交"按钮
    ↓
确认提交操作
    ↓
调用提交接口
    ↓
显示提交结果
```

## 5. 数据字段说明

### 5.1 任务查询参数
| 字段名 | 类型 | 说明 | 必填 |
|--------|------|------|------|
| outtaskno | String | 任务号 | 是 |
| storeroomno | String | 库房编号 | 否 |
| forcesite | String | 强制库位 | 否 |
| forcebatch | String | 强制批次 | 否 |
| taskcomment | String | 任务备注 | 否 |
| workstation | String | 工作站 | 是 |
| collecter | String | 采集人员 | 是 |

### 5.2 采集数据字段
| 字段名 | 类型 | 说明 |
|--------|------|------|
| matcode | String | 物料编码 |
| matname | String | 物料名称 |
| storesiteno | String | 库位编号 |
| hintqty | Number | 任务数量 |
| collectedqty | Number | 采集数量 |
| repqty | Number | 结余库存 |
| hintbatchno | String | 批次号 |
| sn | String | 序列号 |
| pdate | String | 生产日期 |
| vdays | String | 保质期 |

### 5.3 库存验证字段
| 字段名 | 类型 | 说明 |
|--------|------|------|
| storesite | String | 库位编号 |
| matcode | String | 物料编码 |
| batchno | String | 批次号 |
| sn | String | 序列号（可选） |
| qty | Number | 库存数量 |

## 6. 错误处理机制

### 6.1 扫码错误处理
- **空内容检查**: 扫码内容为空时提示重新扫描
- **格式验证**: 不支持的扫码格式提示具体错误
- **步骤验证**: 确保按正确顺序进行扫码操作

### 6.2 库存验证错误
- **库位不存在**: 提示库位无效
- **物料不匹配**: 提示物料编码错误
- **库存不足**: 提示库存数量不足
- **批次错误**: 提示批次信息不匹配

### 6.3 数据提交错误
- **网络异常**: 显示网络错误提示
- **数据验证失败**: 显示具体验证错误信息
- **权限不足**: 提示操作权限不足

### 6.4 页面状态管理
- **加载状态**: 数据查询和提交时显示加载提示
- **事件清理**: 页面返回时清理所有事件监听器
- **数据保护**: 有未提交数据时提示用户确认退出

## 7. 性能优化

### 7.1 数据加载优化
- 虚拟滚动支持大量数据显示
- 分页加载减少内存占用
- 延迟加载非关键数据

### 7.2 用户体验优化
- 实时显示采集进度
- 智能焦点管理
- 快速扫码响应

### 7.3 内存管理
- Map数据结构优化查询性能
- 及时清理无用数据
- 合理的数据缓存策略

## 8. 安全机制

### 8.1 数据验证
- 扫码内容格式验证
- 库存数量范围检查
- 操作权限验证

### 8.2 操作确认
- 关键操作需要二次确认
- 异常操作记录详细日志
- 数据提交前最终确认

### 8.3 错误恢复
- 网络异常自动重试
- 数据丢失保护机制
- 操作回滚支持

## 9. 技术特点

### 9.1 组件化设计
- 扫码组件独立封装
- 表格组件支持虚拟滚动
- 气泡菜单组件化

### 9.2 状态管理
- 复杂的采集状态控制
- 多步骤流程管理
- 数据一致性保证

### 9.3 事件驱动
- 全局扫码事件处理
- 表格交互事件管理
- 页面生命周期控制

## 10. 总结

出库扫描采集页面是平库出库功能的核心操作界面，集成了完整的扫码采集、库存验证、数据管理等功能。页面设计复杂但逻辑清晰，支持多种采集模式和异常处理，为仓库操作人员提供了高效、准确的出库作业工具。该页面的设计充分考虑了实际作业场景的复杂性，具备良好的容错性和用户体验。