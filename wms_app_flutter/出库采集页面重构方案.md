# 出库采集页面重构方案

## 项目背景
将当前出库采集页面从传统ListView重构为现代化表格UI，参考WarehouseCollectionPage实现。

## 目标
- 实现现代化的表格UI，提升用户体验
- 简化BLoC架构，提高代码可维护性
- 统一视觉风格，增强专业感
- 操作入口统一在顶部，避免界面混乱
- 保留所有核心功能，确保业务完整性

## 当前架构分析

### 1. OutboundCollectBloc现状
- **复杂状态管理**：管理任务、任务明细、采集记录、扫码状态等多个状态
- **业务逻辑复杂**：包含扫码验证、库存查询、采集记录管理、数据提交等
- **依赖服务层**：依赖 `OutboundTaskService` 进行数据操作
- **状态类型丰富**：包含loading、loaded、error、scanProcessing、submitting等多种状态

### 2. CommonDataGridBloc特点
- **专注表格数据**：只管理表格的数据加载、分页、选择等基本功能
- **通用性强**：通过泛型支持不同类型的数据
- **简单架构**：只有dataLoader和dataDeleter两个核心功能
- **状态简单**：只管理表格相关状态（数据、分页、选择、错误信息）

## BLoC实施方案

### 方案选择：双BLoC协作模式

#### 架构设计
```
OutboundCollectPage
├── CommonDataGridBloc<OutboundTaskItem> (表格数据管理)
├── OutboundCollectBloc (业务逻辑管理)
└── 页面UI
```

#### 职责分工

**1. CommonDataGridBloc职责**
- 管理任务明细列表的表格显示
- 处理表格的分页加载
- 管理行选择状态
- 提供表格刷新功能

**2. OutboundCollectBloc职责**
- 管理扫码流程（库位验证、物料验证、库存查询）
- 管理采集记录的CRUD操作
- 处理数据提交和异常操作
- 管理当前采集状态和扫码步骤

#### 数据流设计

**1. 初始化流程**
```
页面初始化 → OutboundCollectBloc初始化 → 加载任务明细 → 更新CommonDataGridBloc
```

**2. 数据同步机制**
```dart
// OutboundCollectBloc中
final response = await _outboundTaskService.getOutTaskCollectItemList(query: query);

// 更新CommonDataGridBloc
_gridBloc.add(UpdateTableDataEvent(response.rows));
```

**3. 事件协调**
- **表格刷新**：采集完成后触发表格数据更新
- **状态同步**：采集状态变化时同步更新UI显示

## 页面重构方案

### 1. 页面结构重构 (outbound_collect_page.dart)
- **替换整体布局**：从当前的自定义布局改为 `Scaffold` + `AppBar` + `Column` 结构
- **添加信息卡片**：显示当前采集的详细信息（库位、库存、采集数量、物料、批次等）
- **统一UI风格**：使用统一的颜色主题和样式
- **修改AppBar**：参考实现中的"更多"按钮

### 2. 表格组件集成
- **替换列表视图**：将 `ListView.builder` 替换为 `CommonDataGrid`
- **简化BLoC架构**：直接使用 `CommonDataGridBloc`，移除复杂的嵌套BLoC
- **数据适配**：将 `OutboundTaskItem` 适配为表格数据源
- **移除行内操作按钮**：表格中不显示操作按钮，保持数据展示的纯净性

### 3. 顶部操作菜单
- **添加弹出菜单**：点击"更多"按钮显示下拉菜单
- **菜单选项**：包含"异常采集"和"报缺"两个选项
- **菜单实现**：使用 `PopupMenuButton` 或自定义弹出层

### 4. 创建表格配置
- **新建配置文件**：创建 `outbound_collect_grid_config.dart`
- **表格列定义**：定义物料编码、物料名称、库位、计划数量、批次号、采集状态等列
- **移除操作列**：不需要在表格中显示操作按钮列

### 5. 保留核心功能
- **扫码功能**：保留扫码输入框和扫码处理逻辑
- **Tab切换**：保持任务明细和采集记录的Tab切换
- **数据提交**：保留采集记录的添加、删除和提交功能
- **底部操作**：重构底部按钮样式，但保持功能

### 6. 操作功能实现
- **异常采集**：通过顶部菜单触发，弹出异常采集对话框
- **报缺功能**：通过顶部菜单触发，选择要报缺的任务项
- **状态同步**：操作后同步更新表格数据

## 具体实现步骤

### 阶段1：BLoC重构
1. **简化OutboundCollectBloc**
   - 移除任务明细列表的管理逻辑
   - 保留扫码、采集记录、提交等核心功能
   - 添加与CommonDataGridBloc的通信机制

2. **创建表格BLoC**
   ```dart
   late final CommonDataGridBloc<OutboundTaskItem> _gridBloc = 
       CommonDataGridBloc<OutboundTaskItem>(
         dataLoader: (pageIndex) async {
           // 从OutboundCollectBloc获取数据
           final query = CollectTaskQuery(
             outTaskNo: _currentTask.outTaskNo,
             collecter: _currentUserId,
             pageIndex: pageIndex,
           );
           final response = await _outboundTaskService.getOutTaskCollectItemList(query: query);
           return DataGridResponseData(
             totalPages: (response.total / query.pageSize).ceil(),
             data: response.rows,
           );
         },
       );
   ```

### 阶段2：页面基础结构
1. 重构页面布局，使用参考实现的UI结构
2. 添加信息卡片组件
3. 统一颜色主题和样式
4. 实现AppBar的"更多"按钮和弹出菜单

### 阶段3：表格集成
1. 集成 `CommonDataGrid` 组件
2. 创建表格配置文件（不包含操作列）
3. 适配数据模型

### 阶段4：功能迁移
1. 迁移扫码功能到新布局
2. 适配Tab切换逻辑
3. 迁移数据提交和记录管理功能
4. 实现异常采集和报缺功能

### 阶段5：状态管理优化
1. **状态分离**
   - 表格数据状态：由CommonDataGridBloc管理
   - 业务逻辑状态：由OutboundCollectBloc管理
   - UI状态：由页面组件管理

2. **数据同步**
   ```dart
   // 在OutboundCollectBloc中添加表格刷新方法
   void refreshTaskItems() {
     _gridBloc.add(LoadDataEvent(0));
   }
   
   // 在采集完成后调用
   Future<void> _onSubmitCollectData(...) async {
     // 提交逻辑...
     _gridBloc.add(LoadDataEvent(0)); // 刷新表格
   }
   ```

3. **事件处理优化**
   ```dart
   // 统一事件入口
   void handleTableEvent(dynamic event) {
     if (event is TableSelectionEvent) {
       // 处理表格选择
     } else if (event is ScanEvent) {
       // 处理扫码事件，交给OutboundCollectBloc
       _collectBloc.add(event);
     }
   }
   ```

4. **跨BLoC通信**
   ```dart
   // 使用BlocListener监听状态变化
   BlocListener<OutboundCollectBloc, OutboundCollectState>(
     listener: (context, state) {
       if (state is OutboundCollectSubmitted) {
         _gridBloc.add(LoadDataEvent(0)); // 刷新表格
       }
     },
   )
   ```

### 阶段6：优化完善
1. 优化交互体验
2. 调整响应式布局
3. 测试功能完整性

## 预期效果

### 1. 技术优势
- **职责清晰**：表格显示和数据管理分离，业务逻辑和UI逻辑分离，便于维护和测试
- **复用性强**：CommonDataGridBloc可以复用到其他表格页面，OutboundCollectBloc专注于采集业务逻辑
- **扩展性好**：新增功能不影响现有架构，可以独立优化每个BLoC的性能
- **代码简洁**：减少状态管理的复杂度，提高代码可读性

### 2. 用户体验
- 现代化的表格UI，提升用户体验
- 统一的视觉风格，增强专业感
- 操作入口统一在顶部，避免界面混乱
- 保留所有核心功能，确保业务完整性

## 关键文件修改清单

### 新建文件
1. `outbound_collect_grid_config.dart` - 表格配置文件
2. `outbound_collect_info_card.dart` - 信息卡片组件（可选）

### 修改文件
1. `outbound_collect_page.dart` - 主要页面重构
2. `outbound_collect_bloc.dart` - BLoC架构调整
3. `outbound_collect_state.dart` - 状态管理优化
4. `outbound_collect_event.dart` - 事件定义调整

## 风险评估

### 1. 技术风险
- **架构复杂性**：双BLoC协作可能增加一定的复杂度
- **状态同步**：需要确保两个BLoC之间的状态同步正确
- **性能影响**：需要合理设计避免重复渲染

### 2. 业务风险
- **功能缺失**：重构过程中可能遗漏某些业务功能
- **数据一致性**：需要确保采集数据的准确性
- **用户体验**：新界面可能需要用户适应

### 缓解措施
- **分步实施**：按照阶段逐步实施，每阶段完成后进行充分测试
- **代码审查**：每个阶段完成后进行代码审查
- **用户测试**：邀请实际用户进行测试反馈

## 下次讨论要点

1. BLoC协作模式的具体实现细节
2. 表格配置的列定义和样式
3. 顶部操作菜单的交互设计
4. 信息卡片的数据展示方式
5. 异常采集和报缺功能的具体实现
6. 性能优化和内存管理策略
7. 测试策略和验收标准