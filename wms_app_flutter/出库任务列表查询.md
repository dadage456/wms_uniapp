# 出库任务列表查询详细分析

## 1. 功能概述

出库任务列表查询是平库出库功能的入口模块，负责展示待处理的出库任务列表，支持扫码搜索、分页查询、状态筛选等功能。用户可以通过该页面查看任务概况，并进入具体的采集或明细页面进行后续操作。

## 2. 页面信息

### 2.1 页面文件
- **文件路径**: `/pages/goodsdown/goodsDown.nvue`
- **页面标题**: "平库下架"
- **功能定位**: 出库任务列表查询和管理的主入口

### 2.2 页面结构
```
导航栏 (标题 + 左侧返回 + 右侧接收)
    ↓
搜索输入框 (扫码输入单号)
    ↓
任务列表表格 (支持排序、操作按钮)
    ↓
分页组件 (支持翻页)
    ↓
底部弹窗 (单据状态筛选)
    ↓
底部导航栏 (所有任务按钮)
```

## 3. 接口详细分析

### 3.1 核心查询接口

**接口名称**: `getOutaskList`

**接口配置**:
- **文件位置**: `/api/system/goodsDown.js`
- **接口地址**: `/system/terminal/outList`
- **请求方法**: `GET`
- **基础URL**: `http://10.12.8.123:8086` (配置在config.js中)
- **完整URL**: `http://10.12.8.123:8086/system/terminal/outList`

**接口实现**:
```javascript
export function getOutaskList(data) {
    return request({
        url: '/system/terminal/outList',
        method: 'get',
        params: data
    })
}
```

### 3.2 请求参数详细说明

**参数对象**: `outtask`

```javascript
{
    sortType: '',           // 排序类型 - 控制数据排序方向 (ASC/DESC)
    sortColumn: '',         // 排序字段 - 指定按哪个字段排序
    searchKey: '',          // 搜索关键字 - 支持扫码输入的单号搜索
    userId: '',             // 用户ID - 当前登录用户的唯一标识
    roleoRuserId: '',       // 角色或用户ID - 权限控制相关
    roomTag: '0',           // 库房标签 - 区分不同类型的库房 ('0': 平库)
    batchflag: '0',         // 批次标志 - 批次管理相关标识
    transferType: '0',      // 转移类型 - 物料转移操作类型
    beatflag: 'N',          // 节拍标志 - 是否按节拍执行 ('N': 否, 'Y': 是)
    PageIndex: '1',         // 页码 - 当前查询的页面索引 (从1开始)
    PageSize: '100',        // 页面大小 - 每页显示的记录数
    finshFlg: '0'           // 完成标志 - 任务状态筛选 ('0': 采集中, '1': 所有)
}
```

**参数来源**:
- `userId` 和 `roleoRuserId`: 从 Vuex store 中获取 (`this.$store.state.userid`)
- `searchKey`: 用户手动输入或扫码获取
- `PageIndex`: 分页组件控制
- `finshFlg`: 底部弹窗单选框控制
- 其他参数: 固定默认值

### 3.3 返回数据结构

**响应格式**:
```javascript
{
    code: '200',            // 响应状态码 - '200'表示成功
    msg: 'success',         // 响应消息 - 操作结果描述
    data: {
        rows: [             // 任务列表数据
            {
                outtaskid: '',      // 出库任务ID - 任务的唯一标识
                outtaskno: '',      // 任务号 - 业务任务编号
                orderno: '',        // 出库单号 - 业务单据编号
                po_number: '',      // 来源单号 - 原始订单编号
                storeroomno: '',    // 库房号 - 物料所在库房编号
                workstation: '',    // 工位 - 执行任务的工作站
                taskcomment: '',    // 凭证号 - 财务凭证编号
                schedule_group_name: '', // 班组 - 执行任务的班组名称
                wip_supplement_flag: '', // 紧急补单 - 是否为紧急补单标识
                createtime: '',     // 创建时间 - 任务创建的时间戳
                status: '',         // 状态 - 任务当前执行状态
                taskqty: 0,         // 任务数量 - 计划出库的总数量
                finishqty: 0        // 完成数量 - 已完成出库的数量
            }
        ],
        total: 0            // 总记录数 - 符合条件的记录总数
    }
}
```

**字段用途说明**:
- **outtaskid**: 用于跳转到明细页面和采集页面的关键参数
- **orderno**: 主要的搜索字段，支持扫码输入
- **storeroomno**: 库房信息，用于权限控制和业务逻辑
- **workstation**: 工作站信息，传递给后续页面
- **taskqty/finishqty**: 用于显示任务完成进度

## 4. 查询逻辑详细分析

### 4.1 查询触发时机

1. **页面加载时** (`onLoad`)
   ```javascript
   onLoad() {
       var _this = this;
       _this.getList();  // 初始化加载数据
   }
   ```

2. **扫码输入后** (扫码事件监听)
   ```javascript
   uni.$on('scancodedate', function (content) {
       console.log('扫描二维码:', content);
       _this.outtask.searchKey = content;
       _this.getList();  // 扫码后自动查询
   });
   ```

3. **分页操作时** (分页组件回调)
   ```javascript
   loadData(params) {
       this.current = params.current;
       this.getList();  // 翻页时重新查询
   }
   ```

4. **状态筛选时** (弹窗确认后)
   ```javascript
   search2() {
       this.closePopup();
       this.getList();  // 筛选条件变更后查询
   }
   ```

### 4.2 查询执行流程

```
用户操作触发 → 设置查询参数 → 调用getList() → 显示加载状态 → 发送HTTP请求 → 处理响应数据 → 更新页面显示 → 隐藏加载状态
```

**详细实现**:
```javascript
getList() {
    // 1. 显示加载状态
    uni.showLoading({
        title: '加载中'
    });
    
    console.log('数据加载中...');
    console.log(this.outtask);  // 打印查询参数
    
    // 2. 发送请求
    getOutaskList(this.outtask).then((response) => {
        console.log('请求返回数据：', response);
        
        // 3. 更新数据
        this.outtaskList = response.data.rows;  // 更新任务列表
        this.total = response.data.total;       // 更新总记录数
        
        console.log('返回的json数据:', this.outtaskList);
        
        // 4. 隐藏加载状态
        setTimeout(function () {
            uni.hideLoading();
        }, 10);
        
        // 5. 处理空数据情况
        if (this.outtaskList.length <= 0) {
            uni.showToast({
                icon: 'none',
                duration: 300,
                title: '当前任务列表没有待处理任务1！'
            });
        }
    });
}
```

### 4.3 参数动态设置

**分页参数**:
```javascript
// 分页参数在loadData方法中动态设置
loadData(params) {
    this.current = params.current;  // 更新当前页码
    this.getList();                 // 重新查询
}
```

**搜索参数**:
```javascript
// 扫码搜索
uni.$on('scancodedate', function (content) {
    _this.outtask.searchKey = content;  // 设置搜索关键字
    _this.getList();                    // 执行查询
});
```

**状态筛选参数**:
```javascript
// 单据状态筛选
checkboxChange(e) {
    console.log('finshFlg:', e);
    this.outtask.finshFlg = e.detail.value;  // 更新完成标志
}
```

## 5. 网络请求处理

### 5.1 请求配置

**基础配置** (request.js):
```javascript
const request = config => {
    // Token设置
    const isToken = (config.headers || {}).isToken === false
    config.header = config.header || {}
    if (getToken() && !isToken) {
        config.header['Authorization'] = 'Bearer ' + getToken()
    }
    
    // GET请求参数处理
    if (config.params) {
        let url = config.url + '?' + tansParams(config.params)
        url = url.slice(0, -1)
        config.url = url
    }
    
    // 发送请求
    return new Promise((resolve, reject) => {
        uni.request({
            method: config.method || 'get',
            timeout: config.timeout || 30000,  // 30秒超时
            url: config.baseUrl || baseUrl + config.url,
            data: config.data,
            header: config.header,
            dataType: 'json'
        })
    })
}
```

### 5.2 错误处理机制

**HTTP状态码处理**:
```javascript
const code = res.data.code || 200
const msg = errorCode[code] || res.data.msg || errorCode['default']

if (code === 401) {
    // 登录过期处理
    showConfirm('登录状态已过期，您可以继续留在该页面，或者重新登录?')
} else if (code === 500) {
    // 服务器错误处理
    uni.showModal({
        title: '请求异常',
        showCancel: false,
        content: msg
    });
} else if (code !== 200) {
    // 其他错误处理
    uni.showModal({
        title: '请求异常',
        showCancel: false,
        content: msg
    });
}
```

**网络异常处理**:
```javascript
.catch(error => {
    uni.hideLoading();
    let { message } = error
    if (message === 'Network Error') {
        message = '后端接口连接异常'
    } else if (message.includes('timeout')) {
        message = '系统接口请求超时'
    } else if (message.includes('Request failed with status code')) {
        message = '系统接口' + message.substr(message.length - 3) + '异常'
    }
    toast(message)
    reject(error)
})
```

## 6. 数据展示与交互

### 6.1 表格配置

**列定义** (`column1`):
```javascript
column1: [
    {
        label: '操作',           // 操作列
        fixed: 'right',         // 固定在右侧
        type: 3,                // 按钮类型
        width: 300,             // 列宽
        buttons: [
            {
                text: '采集',       // 进入采集页面
                color: '#465CFF',
                type: 'primary'
            },
            {
                text: '明细',       // 查看任务明细
                color: '#465CFF',
                type: 'success'
            }
        ]
    },
    { prop: 'storeroomno', label: '库房号', sortable: true },
    { prop: 'orderno', label: '出库单号', width: 550, sortable: true },
    { prop: 'po_number', label: '来源单号', width: 550, sortable: true },
    { prop: 'workstation', label: '工位', sortable: true },
    { prop: 'outtaskno', label: '任务号', width: 270, sortable: true },
    { prop: 'wip_supplement_flag', label: '紧急补单' },
    { prop: 'schedule_group_name', label: '班组', width: 350, sortable: true },
    { prop: 'taskcomment', label: '凭证号', width: 420, sortable: true }
]
```

### 6.2 操作按钮处理

**按钮点击事件**:
```javascript
rowOperate(rowItem) {
    console.log(rowItem.buttonIndex);
    if (rowItem.buttonIndex === 0) {
        // 采集按钮 - 跳转到采集页面
        this.actionsClick('task_collect/goodDownNvue', rowItem.item);
    }
    if (rowItem.buttonIndex === 1) {
        // 明细按钮 - 跳转到明细页面
        this.detailClick('goodsDownDetail', rowItem.item.outtaskid, rowItem.item.workstation);
    }
}
```

**页面跳转逻辑**:
```javascript
// 进入采集界面
actionsClick(url, item) {
    item.finshFlg = this.outtask.finshFlg;  // 传递状态标志
    uni.$off('scancodedate');               // 移除事件监听
    setTimeout(() => {
        uni.reLaunch({
            url: url + '?item=' + encodeURIComponent(JSON.stringify(item))
        });
    }, 100);
}

// 进入明细界面
detailClick(url, outtaskid, workstation) {
    uni.$off('scancodedate');               // 移除事件监听
    setTimeout(() => {
        uni.reLaunch({
            url: url + '?outtaskid=' + outtaskid + '&workstation=' + workstation
        });
    }, 100);
}
```

### 6.3 分页处理

**分页组件配置**:
```html
<fui-pagination 
    :total="total"          <!-- 总记录数 -->
    pageSize="100"          <!-- 每页大小 -->
    :pageType="2"           <!-- 分页类型 -->
    :current="current"      <!-- 当前页码 -->
    @change="loadData"      <!-- 页码变更事件 -->
></fui-pagination>
```

**分页事件处理**:
```javascript
loadData(params) {
    this.current = params.current;  // 更新当前页码
    this.getList();                 // 重新查询数据
}
```

## 7. 扫码功能集成

### 7.1 扫码组件

**组件引入**:
```javascript
import scanCode from '@/components/scan-code/scan-code.vue';

components: {
    scanCode
}
```

**模板使用**:
```html
<scanCode></scanCode>
```

### 7.2 扫码事件处理

**事件监听注册**:
```javascript
onLoad() {
    var _this = this;
    _this.getList();
    
    // 注册扫码事件监听
    uni.$on('scancodedate', function (content) {
        console.log('扫描二维码:', content);
        _this.outtask.searchKey = content;  // 设置搜索关键字
        _this.getList();                    // 执行查询
    });
}
```

**事件监听清理**:
```javascript
// 页面返回时清理
page_back() {
    uni.$off('scancodedate');  // 移除监听
    uni.reLaunch({
        url: '/pages/index'
    });
}

// 页面跳转前清理
actionsClick(url, item) {
    uni.$off('scancodedate');  // 移除监听
    // ... 跳转逻辑
}
```

## 8. 状态筛选功能

### 8.1 筛选弹窗

**弹窗模板**:
```html
<fui-bottom-popup :show="show_popup" :maskClosable="false">
    <view class="fui-popup__container">
        <text class="fui-title">全部单据选择</text>
        <view class="fui-btn__box">
            <fui-radio-group name="radio" v-model="val" @change="checkboxChange">
                <view class="fui-list__item">
                    <fui-label>
                        <view class="fui-align__center">
                            <fui-radio value="1"></fui-radio>
                            <text class="fui-text">所有单据</text>
                        </view>
                    </fui-label>
                    <fui-label :margin="['0', '0', '0', '40rpx']">
                        <view class="fui-align__center">
                            <fui-radio value="0" checked></fui-radio>
                            <text class="fui-text">采集中单据</text>
                        </view>
                    </fui-label>
                </view>
            </fui-radio-group>
        </view>
        <view class="fui-btn__box">
            <fui-button width="240rpx" height="80rpx" text="确认" @click="search2()"></fui-button>
        </view>
    </view>
</fui-bottom-popup>
```

### 8.2 筛选逻辑

**状态值定义**:
- `finshFlg: '0'`: 采集中单据 (默认)
- `finshFlg: '1'`: 所有单据

**筛选事件处理**:
```javascript
// 单选框变更事件
checkboxChange(e) {
    console.log('finshFlg:', e);
    this.outtask.finshFlg = e.detail.value;  // 更新筛选条件
}

// 确认筛选
search2() {
    this.closePopup();  // 关闭弹窗
    this.getList();     // 重新查询
}

// 显示筛选弹窗
showPopup() {
    this.show_popup = true;
}

// 关闭筛选弹窗
closePopup() {
    this.show_popup = false;
}
```

## 9. 性能优化策略

### 9.1 数据加载优化

1. **分页加载**: 每页最多100条记录，避免一次性加载大量数据
2. **按需查询**: 只在必要时触发查询，避免频繁请求
3. **加载状态**: 显示加载提示，提升用户体验

### 9.2 内存管理

1. **事件监听清理**: 页面跳转时及时清理事件监听器
2. **定时器管理**: 合理使用setTimeout，避免内存泄漏

### 9.3 用户体验优化

1. **即时反馈**: 扫码后立即查询，无需手动触发
2. **错误提示**: 友好的错误信息提示
3. **空数据处理**: 无数据时显示提示信息

## 10. 安全机制

### 10.1 身份验证

**Token机制**:
```javascript
if (getToken() && !isToken) {
    config.header['Authorization'] = 'Bearer ' + getToken()
}
```

**登录状态检查**:
```javascript
if (code === 401) {
    showConfirm('登录状态已过期，您可以继续留在该页面，或者重新登录?').then(res => {
        if (res.confirm) {
            store.dispatch('LogOut').then(res => {
                uni.reLaunch({
                    url: '/pages/loginPwd/loginPwd'
                })
            })
        }
    })
}
```

### 10.2 数据安全

1. **参数验证**: 前端基础参数验证
2. **权限控制**: 基于用户ID和角色的权限控制
3. **数据传输**: HTTPS加密传输 (生产环境)

## 11. 错误处理与调试

### 11.1 日志记录

**关键节点日志**:
```javascript
console.log('数据加载中...');
console.log(this.outtask);              // 查询参数
console.log('请求返回数据：', response);   // 响应数据
console.log('返回的json数据:', this.outtaskList); // 处理后数据
```

### 11.2 异常处理

**网络异常**:
- 连接超时: 30秒超时设置
- 网络错误: 友好提示信息
- 服务器错误: 状态码分类处理

**业务异常**:
- 空数据: 提示无待处理任务
- 权限不足: 自动跳转登录页
- 参数错误: 前端验证和后端验证

## 12. 总结

出库任务列表查询功能作为平库出库的入口模块，具有以下特点：

### 12.1 功能特点
1. **查询灵活**: 支持扫码搜索、状态筛选、分页查询
2. **操作便捷**: 直接从列表跳转到采集或明细页面
3. **实时性强**: 扫码后立即查询，数据实时更新
4. **用户友好**: 加载状态、错误提示、空数据处理

### 12.2 技术特点
1. **架构清晰**: 分层设计，职责明确
2. **错误处理**: 完善的异常处理机制
3. **性能优化**: 分页加载、事件管理、内存优化
4. **安全可靠**: Token认证、权限控制、数据验证

### 12.3 扩展性
1. **接口标准**: 统一的请求响应格式
2. **组件复用**: 扫码组件、表格组件可复用
3. **配置灵活**: 查询参数、显示列可配置
4. **维护性好**: 代码结构清晰，注释完善

该功能为整个出库流程提供了稳定可靠的入口，是仓库管理系统的重要组成部分。