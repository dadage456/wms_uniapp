# 出库任务明细列表页改造实施步骤

## 项目概述

将出库任务明细列表页从当前的自定义ListView架构改造为与任务列表页一致的CommonDataGrid架构，提升代码复用性和用户体验一致性。

## 前置条件

- 熟悉Flutter和BLoC模式
- 了解项目现有的CommonDataGrid组件
- 掌握Freezed和JSON序列化

## 实施步骤

### 第一阶段：核心架构改造（高优先级）

#### 步骤1：创建表格配置文件

**目标文件**: `/lib/modules/outbound/task_details/config/outbound_task_item_grid_config.dart`

**参考文件**: `/lib/modules/outbound/task_list/config/outbound_task_grid_config.dart`

**具体操作**:
1. 创建config目录（如果不存在）
2. 创建配置文件，定义以下列：
   - 操作列（选择框、操作按钮）
   - 任务明细ID
   - 物料编码
   - 物料名称
   - 规格型号
   - 计划数量
   - 完成数量
   - 库位
   - 状态
   - 创建时间

**代码结构**:
```dart
import 'package:flutter/material.dart';
import '../../../../common_widgets/common_grid/common_data_grid.dart';
import '../models/outbound_task_item.dart';

typedef void OutboundTaskItemOperation(OutboundTaskItem item, int type);

class OutboundTaskItemGridConfig {
  static List<GridColumnConfig<OutboundTaskItem>> getColumns(
    OutboundTaskItemOperation? operation,
  ) {
    return [
      // 定义各列配置
    ];
  }
}
```

#### 步骤2：重构BLoC架构

**目标文件**: `/lib/modules/outbound/task_details/bloc/outbound_task_detail_bloc.dart`

**参考文件**: `/lib/modules/outbound/task_list/bloc/outbound_task_bloc.dart`

**具体操作**:
1. 导入CommonDataGridBloc相关依赖
2. 添加gridBloc属性
3. 创建DataLoader函数
4. 修改事件处理逻辑
5. 保留现有的扫码和批量操作事件

**关键代码结构**:
```dart
class OutboundTaskDetailBloc extends Bloc<OutboundTaskDetailEvent, OutboundTaskDetailState> {
  // 当前查询参数
  late OutboundTaskItemQuery currentQuery = getDefaultQuery();
  
  // 表格bloc
  late final gridBloc = CommonDataGridBloc(dataLoader: createDataLoader());
  
  // 创建数据加载器
  DataLoader<OutboundTaskItem> createDataLoader() {
    return (int pageIndex) async {
      // 数据加载逻辑
    };
  }
}
```

#### 步骤3：重构页面UI

**目标文件**: `/lib/modules/outbound/task_details/outbound_task_detail_page.dart`

**具体操作**:
1. 导入CommonDataGrid相关组件
2. 替换ListView.builder为CommonDataGrid
3. 修改搜索栏样式，参照任务列表页
4. 集成BlocConsumer模式
5. 保留扫码和批量操作功能

**UI结构变更**:
```dart
// 原有结构
ListView.builder(
  controller: _scrollController,
  itemBuilder: (context, index) => OutboundTaskItemCard(...),
)

// 新结构
CommonDataGrid<OutboundTaskItem>(
  columns: OutboundTaskItemGridConfig.getColumns(...),
  onLoadData: (pageIndex) async {
    _gridBloc.add(LoadDataEvent(pageIndex));
  },
  // 其他配置
)
```

### 第二阶段：功能适配和优化（中优先级）

#### 步骤4：模型适配

**目标文件**: `/lib/modules/outbound/task_details/models/outbound_task_item.dart`

**具体操作**:
1. 检查现有字段是否满足表格显示需求
2. 添加必要的格式化方法
3. 确保JSON序列化正常工作

#### 步骤5：特有功能集成

**涉及文件**:
- `widgets/outbound_scan_dialog.dart`
- `widgets/outbound_batch_action_bar.dart`

**具体操作**:
1. 保持扫码对话框功能不变
2. 适配批量操作栏到新的选择机制
3. 集成扫码结果到表格搜索

#### 步骤6：测试验证

**测试清单**:
- [ ] 数据加载和分页
- [ ] 搜索功能
- [ ] 扫码功能
- [ ] 批量选择和操作
- [ ] 错误处理
- [ ] 加载状态显示

### 第三阶段：样式统一（低优先级）

#### 步骤7：样式和交互统一

**具体操作**:
1. 应用统一的颜色主题
2. 统一按钮样式
3. 优化布局间距
4. 确保交互一致性

## 关键技术要点

### 1. CommonDataGrid集成

```dart
// BlocProvider包装
BlocProvider(
  create: (context) => _gridBloc,
  child: BlocConsumer<CommonDataGridBloc<OutboundTaskItem>, CommonDataGridState<OutboundTaskItem>>(
    listener: (context, state) {
      // 状态监听逻辑
    },
    builder: (context, state) {
      return CommonDataGrid<OutboundTaskItem>(
        // 配置参数
      );
    },
  ),
)
```

### 2. 数据加载器实现

```dart
DataLoader<OutboundTaskItem> createDataLoader() {
  return (int pageIndex) async {
    final query = currentQuery.copyWith(pageIndex: pageIndex);
    final data = await outboundTaskService.getOutboundTaskItemList(query: query);
    
    final totalPages = (data.total / query.pageSize).ceil();
    
    return DataGridResponseData<OutboundTaskItem>(
      totalPages: totalPages,
      data: data.rows,
    );
  };
}
```

### 3. 搜索功能集成

```dart
void _handleSearch(String searchKey) {
  currentQuery = currentQuery.copyWith(
    searchKey: searchKey,
    pageIndex: 0,
  );
  gridBloc.add(LoadDataEvent(currentQuery.pageIndex));
}
```

### 4. 批量操作适配

```dart
// 利用CommonDataGrid的选择机制
CommonDataGrid<OutboundTaskItem>(
  allowSelect: true,
  selectedRows: state.selectedRows,
  onSelectionChanged: (selectedIds) {
    // 处理选择变化
  },
)
```

## 注意事项

1. **渐进式改造**: 分步骤实施，确保每个步骤都能正常工作
2. **功能保留**: 确保扫码、批量操作等特有功能不丢失
3. **错误处理**: 保持原有的错误处理机制
4. **性能考虑**: 利用CommonDataGrid的内置优化
5. **测试覆盖**: 每个步骤完成后进行充分测试

## 预期收益

- **代码复用**: 利用现有的表格组件和数据管理框架
- **维护性**: 统一的架构模式便于后续维护
- **用户体验**: 一致的界面风格和交互方式
- **开发效率**: 减少重复开发工作
- **功能扩展**: 更容易添加新的功能特性

## 完成标准

- [ ] 所有功能正常工作
- [ ] 界面风格与任务列表页一致
- [ ] 性能表现良好
- [ ] 代码质量符合项目标准
- [ ] 通过所有测试用例

---

**文档版本**: 1.0  
**创建日期**: 2024年1月  
**适用项目**: WMS App 出库模块